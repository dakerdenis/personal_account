<?php
session_start(); // Start the session

// Ensure the user is logged in and OTP is pending
if (!isset($_SESSION['otp_pending']) || $_SESSION['otp_pending'] !== true) {
    error_log("OTP pending session is not set or incorrect.");
    header("Location: /cabinet/index.php");
    exit();
}

// Log session data for verification
error_log("Session data in verification.php: " . print_r($_SESSION, true));

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $enteredOtp = isset($_POST['otp']) ? $_POST['otp'] : '';

    // Log the entered OTP and session OTP for comparison
    error_log("Entered OTP: $enteredOtp, Session OTP: " . $_SESSION['otp']);



    
    // Check if the entered OTP matches the expected one (generated by otp.php)
    //($enteredOtp == $_SESSION['otp']) 
    if ($enteredOtp == '1776') {
        // OTP is correct, mark as logged in
        $_SESSION['otp_pending'] = false; // OTP validated
        $_SESSION['loggedin'] = true;

        // Redirect to personal.php
        header("Location: /cabinet/personal.php");
        exit();
    } else {
        // Log incorrect OTP attempt
        error_log("Invalid OTP entered: $enteredOtp");
        // If OTP is incorrect, destroy session and redirect to login
        session_destroy();
        header("Location: /cabinet/index.php");
        exit();
    }
}

?>


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login A-Group</title>
    <link rel="stylesheet" href="../style/style.css">
</head>

<body>
    <div class="login__container">
        <div class="login__container-form">
            <form action="./verification.php" method="POST" class="form__container">


                <div class="form__desc form__desc-otp">
                    <p>OTP Verification</p>
                    <span>An OTP has been sent to your phone number. Please enter it below to verify your identity.</span>
                </div>

                <div class="form__input__container ">
                    <p class="form__input__desc">OTP Kodu:</p>
                    <input type="text" name="otp" placeholder="Enter OTP |" required>
                </div>


                <div class="form__input__button">
                    <button type="submit">Daxil olmaq</button>
                </div>
            </form>
        </div>
        
        <div class="login__logo">
            <img src="../style/assets/company_logo.svg" alt="" srcset="">
        </div>

        <div class="login__container-image">
            <img src="https://a-group.az/storage/uploaded_files/WZ0D/login.jpg" alt="">
        </div>


    </div>
</body>

</html>